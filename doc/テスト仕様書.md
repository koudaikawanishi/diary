# API テスト仕様書: 日記機能

## 1. 概要

本仕様書は、日記 API の機能に関するテスト項目を定義するものです。
この API は、特定の日付（本日）の日記の作成、取得、更新、削除機能を提供します。

## 2. テスト対象 API エンドポイント

- `GET /api/diary`
- `POST /api/diary`
- `PUT /api/diary`
- `DELETE /api/diary`

## 3. テストの観点

- 各 HTTP メソッドが期待通りに動作すること。
- リクエストボディのバリデーションが正しく行われること。
- データが存在する場合としない場合の挙動が正しいこと。
- エラーハンドリングが適切に行われること。

## 4. テストケース

### 4.1. GET /api/diary - 今日の日記を取得

| テスト ID | テスト項目                                     | 前提条件                           | 操作手順                      | 期待結果                                                                    | 備考 |
| :-------- | :--------------------------------------------- | :--------------------------------- | :---------------------------- | :-------------------------------------------------------------------------- | :--- |
| GET-001   | 今日の日記が存在する場合、日記が取得できること | 今日の日付で日記データが存在する   | `GET /api/diary` をリクエスト | ステータスコード `200 OK` <br> レスポンスボディに日記オブジェクトが含まれる |      |
| GET-002   | 今日の日記が存在しない場合、null が返ること    | 今日の日付で日記データが存在しない | `GET /api/diary` をリクエスト | ステータスコード `200 OK` <br> レスポンスボディが `null` であること         |      |

---

### 4.2. POST /api/diary - 今日の日記を作成

| テスト ID | テスト項目                                              | 前提条件                             | 操作手順                                                                 | 期待結果                                                                                                                                                                                                                                                                     | 備考                                                                                                                                                                                                                                                                  |
| :-------- | :------------------------------------------------------ | :----------------------------------- | :----------------------------------------------------------------------- | :--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | :-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| POST-001  | 正常な内容で日記を新規作成できること                    | 今日の日付で日記データが存在しない   | `POST /api/diary` <br> リクエストボディ: `{"content": "今日の日記です"}` | ステータスコード `201 Created` <br> レスポンスボディに作成された日記オブジェクト（content, date を含む）が含まれる                                                                                                                                                           |                                                                                                                                                                                                                                                                       |
| POST-002  | リクエストボディの`content`が空の場合、エラーとなること | -                                    | `POST /api/diary` <br> リクエストボディ: `{"content": ""}`               | ステータスコード `400 Bad Request` <br> レスポンスボディにエラーメッセージ `{"error": "Content is required and max 140 chars"}` が含まれる                                                                                                                                   |                                                                                                                                                                                                                                                                       |
| POST-003  | リクエストボディの`content`がない場合、エラーとなること | -                                    | `POST /api/diary` <br> リクエストボディ: `{}`                            | ステータスコード `400 Bad Request` <br> レスポンスボディにエラーメッセージ `{"error": "Content is required and max 140 chars"}` が含まれる                                                                                                                                   |                                                                                                                                                                                                                                                                       |
| POST-004  | `content`が 140 文字を超える場合、エラーとなること      | -                                    | `POST /api/diary` <br> リクエストボディ: `{"content": "a".repeat(141)}`  | ステータスコード `400 Bad Request` <br> レスポンスボディにエラーメッセージ `{"error": "Content is required and max 140 chars"}` が含まれる                                                                                                                                   |                                                                                                                                                                                                                                                                       |
| POST-005  | `content`がちょうど 140 文字の場合、作成できること      | 今日の日付で日記データが存在しない   | `POST /api/diary` <br> リクエストボディ: `{"content": "a".repeat(140)}`  | ステータスコード `201 Created` <br> レスポンスボディに作成された日記オブジェクトが含まれる                                                                                                                                                                                   |                                                                                                                                                                                                                                                                       |
| POST-006  | 今日の日記が既に存在する場合の挙動確認                  | 今日の日付で日記データが既に存在する | `POST /api/diary` <br> リクエストボディ: `{"content": "新しい日記"}`     | **現在のスクリプトでは、このリクエストは `case 'PUT'` のロジックにフォールスルーする。** <br> その結果、`PUT` のバリデーションエラー(content が空または 140 字超)になるか、`PUT`の更新処理に進もうとして既存データに対する更新の挙動を示すか、404 エラーを返す可能性がある。 | **要注意**: スクリプトの`case 'POST'`で`existing`が true の場合の処理が明示的に抜けておらず、`case 'PUT'`に処理が流れる設計になっています。これは意図しない挙動の可能性があり、修正が推奨されます。適切なエラーレスポンス（例: 409 Conflict）を返すようにすべきです。 |

---

### 4.3. PUT /api/diary - 今日の日記を更新

| テスト ID | テスト項目                                              | 前提条件                           | 操作手順                                                                    | 期待結果                                                                                                                                   | 備考 |
| :-------- | :------------------------------------------------------ | :--------------------------------- | :-------------------------------------------------------------------------- | :----------------------------------------------------------------------------------------------------------------------------------------- | :--- |
| PUT-001   | 正常な内容で日記を更新できること                        | 今日の日付で日記データが存在する   | `PUT /api/diary` <br> リクエストボディ: `{"content": "更新された日記です"}` | ステータスコード `200 OK` <br> レスポンスボディに更新された日記オブジェクトが含まれる                                                      |      |
| PUT-002   | リクエストボディの`content`が空の場合、エラーとなること | 今日の日付で日記データが存在する   | `PUT /api/diary` <br> リクエストボディ: `{"content": ""}`                   | ステータスコード `400 Bad Request` <br> レスポンスボディにエラーメッセージ `{"error": "Content is required and max 140 chars"}` が含まれる |      |
| PUT-003   | リクエストボディの`content`がない場合、エラーとなること | 今日の日付で日記データが存在する   | `PUT /api/diary` <br> リクエストボディ: `{}`                                | ステータスコード `400 Bad Request` <br> レスポンスボディにエラーメッセージ `{"error": "Content is required and max 140 chars"}` が含まれる |      |
| PUT-004   | `content`が 140 文字を超える場合、エラーとなること      | 今日の日付で日記データが存在する   | `PUT /api/diary` <br> リクエストボディ: `{"content": "a".repeat(141)}`      | ステータスコード `400 Bad Request` <br> レスポンスボディにエラーメッセージ `{"error": "Content is required and max 140 chars"}` が含まれる |      |
| PUT-005   | `content`がちょうど 140 文字の場合、更新できること      | 今日の日付で日記データが存在する   | `PUT /api/diary` <br> リクエストボディ: `{"content": "a".repeat(140)}`      | ステータスコード `200 OK` <br> レスポンスボディに更新された日記オブジェクトが含まれる                                                      |      |
| PUT-006   | 更新対象の日記が存在しない場合、エラーとなること        | 今日の日付で日記データが存在しない | `PUT /api/diary` <br> リクエストボディ: `{"content": "更新テスト"}`         | ステータスコード `404 Not Found` <br> レスポンスボディにエラーメッセージ `{"error": "Diary entry not found for today"}` が含まれる         |      |

---

### 4.4. DELETE /api/diary - 今日の日記を削除

| テスト ID | テスト項目                                           | 前提条件                           | 操作手順                         | 期待結果                                                              | 備考                                                                      |
| :-------- | :--------------------------------------------------- | :--------------------------------- | :------------------------------- | :-------------------------------------------------------------------- | :------------------------------------------------------------------------ |
| DEL-001   | 今日の日記が存在する場合、日記を削除できること       | 今日の日付で日記データが存在する   | `DELETE /api/diary` をリクエスト | ステータスコード `204 No Content` <br> レスポンスボディは空であること | 削除後、`GET`で取得できないことを確認                                     |
| DEL-002   | 今日の日記が存在しない場合でも、エラーにならないこと | 今日の日付で日記データが存在しない | `DELETE /api/diary` をリクエスト | ステータスコード `204 No Content` <br> レスポンスボディは空であること | `prisma.diary.deleteMany`は対象がなくてもエラーを返さない仕様に基づきます |

---

### 4.5. その他のリクエスト

| テスト ID | テスト項目                                                           | 前提条件 | 操作手順                                                      | 期待結果                                                                                                          | 備考 |
| :-------- | :------------------------------------------------------------------- | :------- | :------------------------------------------------------------ | :---------------------------------------------------------------------------------------------------------------- | :--- |
| OTH-001   | 許可されていない HTTP メソッドでリクエストした場合、エラーとなること | -        | `PATCH /api/diary` など、許可されていないメソッドでリクエスト | ステータスコード `405 Method Not Allowed` <br> レスポンスヘッダー `Allow` に `GET,POST,PUT,DELETE` が含まれること |      |

---

### 4.6. エラーハンドリング

| テスト ID | テスト項目                                 | 前提条件                                     | 操作手順                                                                  | 期待結果                                                                                                             | 備考                                                                               |
| :-------- | :----------------------------------------- | :------------------------------------------- | :------------------------------------------------------------------------ | :------------------------------------------------------------------------------------------------------------------- | :--------------------------------------------------------------------------------- |
| ERR-001   | サーバー内部エラーが発生した場合の挙動確認 | Prisma Client がデータベース接続に失敗する等 | 内部エラーを意図的に発生させる (例: DB サーバーを停止させて API をコール) | ステータスコード `500 Internal Server Error` <br> レスポンスボディに `{"error": "Internal server error"}` が含まれる | 実際のテストでは DB のモック化やエラー注入などで擬似的に発生させることを想定します |
